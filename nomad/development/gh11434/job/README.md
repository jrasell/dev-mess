# Nomad Job Reg/Dereg Eval Priority Setting
Nomad issue [#11434](https://github.com/hashicorp/nomad/issues/11434) detailed
the enhancement which allows operators to set the evaluation priorities on job
registration and job deregistration requests. The priority affects all
evaluations as a result of the initial submission. This feature is useful in
congested Nomad clusters where operators may wish to shed load at an expedited
rate. By default, the job priority is used.

### Assumptions
- Nomad is running with the HTTP API available at `http://127.0.0.1:4646`.
- The Nomad binary running the agent and local commands includes the
enhancement.
- [curl](https://curl.se/) is available on your local system.
- The job specification is available within your CWD.

1. Open a new terminal window and follow the evaluation events from Nomad. This
will be a long-running command. The first command will output the raw event 
detail to the console, the second filters the output and is useful for someone
with knowledge of this feature.
```shell
$ curl -s -v -N http://127.0.0.1:4646/v1/event/stream\?topic\=Evaluation
$ curl -s -v -N http://127.0.0.1:4646/v1/event/stream\?topic\=Evaluation | jq  '.Events[0] | "\(.Payload.Evaluation.ID), \(.Payload.Evaluation.TriggeredBy), \(.Payload.Evaluation.Status), \(.Payload.Evaluation.Priority)"'
```

2. Submit the job to Nomad without setting a custom eval priority.
```shell
$ nomad job run gh11434.nomad
```

The evaluations from this job registration will all have the job priority value
of 49. The output should look similar to that shown below. The end of the job
registration cycle will be when the run command exits with 0 code.
```
{"Events":[{"FilterKeys":["gh11434",""],"Index":10,"Key":"2aa7f34f-f584-1dad-2afa-b20ab09b0578","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":10,"CreateTime":1637148288568989000,"ID":"2aa7f34f-f584-1dad-2afa-b20ab09b0578","JobID":"gh11434","JobModifyIndex":10,"ModifyIndex":10,"ModifyTime":1637148288568989000,"Namespace":"default","Priority":49,"Status":"pending","TriggeredBy":"job-register","Type":"service"}},"Topic":"Evaluation","Type":"JobRegistered"}],"Index":10}
{"Events":[{"FilterKeys":["gh11434",""],"Index":11,"Key":"2aa7f34f-f584-1dad-2afa-b20ab09b0578","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":10,"CreateTime":1637148288568989000,"ID":"2aa7f34f-f584-1dad-2afa-b20ab09b0578","JobID":"gh11434","JobModifyIndex":10,"ModifyIndex":11,"ModifyTime":1637148288568989000,"Namespace":"default","Priority":49,"Status":"pending","TriggeredBy":"job-register","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":11}
{"Events":[{"FilterKeys":["gh11434","e60cc0d4-db61-5c06-8bb1-6787afe54b94"],"Index":12,"Key":"2aa7f34f-f584-1dad-2afa-b20ab09b0578","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":10,"CreateTime":1637148288568989000,"DeploymentID":"e60cc0d4-db61-5c06-8bb1-6787afe54b94","ID":"2aa7f34f-f584-1dad-2afa-b20ab09b0578","JobID":"gh11434","JobModifyIndex":10,"ModifyIndex":12,"ModifyTime":1637148288580130000,"Namespace":"default","Priority":49,"QueuedAllocations":{"cache":0},"SnapshotIndex":10,"Status":"complete","TriggeredBy":"job-register","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":12}
{"Events":[{"FilterKeys":["gh11434","e60cc0d4-db61-5c06-8bb1-6787afe54b94"],"Index":18,"Key":"6bab18e8-82a1-40b9-5ff0-3ef5a0c82daa","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":18,"CreateTime":1637148300479088000,"DeploymentID":"e60cc0d4-db61-5c06-8bb1-6787afe54b94","ID":"6bab18e8-82a1-40b9-5ff0-3ef5a0c82daa","JobID":"gh11434","ModifyIndex":18,"ModifyTime":1637148300479088000,"Namespace":"default","Priority":49,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"AllocationUpdateDesiredStatus"}],"Index":18}
{"Events":[{"FilterKeys":["gh11434","e60cc0d4-db61-5c06-8bb1-6787afe54b94"],"Index":19,"Key":"6bab18e8-82a1-40b9-5ff0-3ef5a0c82daa","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":18,"CreateTime":1637148300479088000,"DeploymentID":"e60cc0d4-db61-5c06-8bb1-6787afe54b94","ID":"6bab18e8-82a1-40b9-5ff0-3ef5a0c82daa","JobID":"gh11434","ModifyIndex":19,"ModifyTime":1637148300479088000,"Namespace":"default","Priority":49,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":19}
{"Events":[{"FilterKeys":["gh11434","e60cc0d4-db61-5c06-8bb1-6787afe54b94"],"Index":20,"Key":"6bab18e8-82a1-40b9-5ff0-3ef5a0c82daa","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":18,"CreateTime":1637148300479088000,"DeploymentID":"e60cc0d4-db61-5c06-8bb1-6787afe54b94","ID":"6bab18e8-82a1-40b9-5ff0-3ef5a0c82daa","JobID":"gh11434","ModifyIndex":20,"ModifyTime":1637148300736407000,"Namespace":"default","Priority":49,"QueuedAllocations":{"cache":0},"SnapshotIndex":18,"Status":"complete","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":20}
```

3. Trigger a job update, using a custom evaluation priority.
```shell
$ nomad job run -eval-priority=90 -var image=redis:4.0 gh11434.nomad
```

The evaluation events resulting from this job update will all have the specified
eval priority applied.
```
{"Events":[{"FilterKeys":["gh11434",""],"Index":23,"Key":"859b19d2-450b-707b-df59-a2f1cb4b9602","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":23,"CreateTime":1637148369600194000,"ID":"859b19d2-450b-707b-df59-a2f1cb4b9602","JobID":"gh11434","JobModifyIndex":23,"ModifyIndex":23,"ModifyTime":1637148369600194000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"job-register","Type":"service"}},"Topic":"Evaluation","Type":"JobRegistered"}],"Index":23}
{"Events":[{"FilterKeys":["gh11434",""],"Index":24,"Key":"859b19d2-450b-707b-df59-a2f1cb4b9602","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":23,"CreateTime":1637148369600194000,"ID":"859b19d2-450b-707b-df59-a2f1cb4b9602","JobID":"gh11434","JobModifyIndex":23,"ModifyIndex":24,"ModifyTime":1637148369600194000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"job-register","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":24}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":25,"Key":"859b19d2-450b-707b-df59-a2f1cb4b9602","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":23,"CreateTime":1637148369600194000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"859b19d2-450b-707b-df59-a2f1cb4b9602","JobID":"gh11434","JobModifyIndex":23,"ModifyIndex":25,"ModifyTime":1637148369606264000,"Namespace":"default","Priority":90,"QueuedAllocations":{"cache":0},"SnapshotIndex":23,"Status":"complete","TriggeredBy":"job-register","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":25}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":30,"Key":"7242a67f-d2ec-2831-4de5-7c8b096ea9fe","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":30,"CreateTime":1637148381515924000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"7242a67f-d2ec-2831-4de5-7c8b096ea9fe","JobID":"gh11434","ModifyIndex":30,"ModifyTime":1637148381515924000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"AllocationUpdateDesiredStatus"}],"Index":30}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":31,"Key":"7242a67f-d2ec-2831-4de5-7c8b096ea9fe","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":30,"CreateTime":1637148381515924000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"7242a67f-d2ec-2831-4de5-7c8b096ea9fe","JobID":"gh11434","ModifyIndex":31,"ModifyTime":1637148381515924000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":31}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":32,"Key":"7242a67f-d2ec-2831-4de5-7c8b096ea9fe","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":30,"CreateTime":1637148381515924000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"7242a67f-d2ec-2831-4de5-7c8b096ea9fe","JobID":"gh11434","ModifyIndex":32,"ModifyTime":1637148381770180000,"Namespace":"default","Priority":90,"QueuedAllocations":{"cache":0},"SnapshotIndex":30,"Status":"complete","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":32}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":37,"Key":"59b490b4-6d8f-57e6-d99a-91aef0b7b52e","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":37,"CreateTime":1637148393538552000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"59b490b4-6d8f-57e6-d99a-91aef0b7b52e","JobID":"gh11434","ModifyIndex":37,"ModifyTime":1637148393538552000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"AllocationUpdateDesiredStatus"}],"Index":37}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":38,"Key":"59b490b4-6d8f-57e6-d99a-91aef0b7b52e","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":37,"CreateTime":1637148393538552000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"59b490b4-6d8f-57e6-d99a-91aef0b7b52e","JobID":"gh11434","ModifyIndex":38,"ModifyTime":1637148393538552000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":38}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":39,"Key":"59b490b4-6d8f-57e6-d99a-91aef0b7b52e","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":37,"CreateTime":1637148393538552000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"59b490b4-6d8f-57e6-d99a-91aef0b7b52e","JobID":"gh11434","ModifyIndex":39,"ModifyTime":1637148393795522000,"Namespace":"default","Priority":90,"QueuedAllocations":{"cache":0},"SnapshotIndex":37,"Status":"complete","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":39}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":44,"Key":"52b66714-b10b-0356-e447-0ac4e257cb0a","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":44,"CreateTime":1637148405563816000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"52b66714-b10b-0356-e447-0ac4e257cb0a","JobID":"gh11434","ModifyIndex":44,"ModifyTime":1637148405563816000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"AllocationUpdateDesiredStatus"}],"Index":44}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":45,"Key":"52b66714-b10b-0356-e447-0ac4e257cb0a","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":44,"CreateTime":1637148405563816000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"52b66714-b10b-0356-e447-0ac4e257cb0a","JobID":"gh11434","ModifyIndex":45,"ModifyTime":1637148405563816000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":45}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":46,"Key":"52b66714-b10b-0356-e447-0ac4e257cb0a","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":44,"CreateTime":1637148405563816000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"52b66714-b10b-0356-e447-0ac4e257cb0a","JobID":"gh11434","ModifyIndex":46,"ModifyTime":1637148405819643000,"Namespace":"default","Priority":90,"QueuedAllocations":{"cache":0},"SnapshotIndex":44,"Status":"complete","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":46}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":51,"Key":"48cf5aac-b3d1-4ead-ec9e-20b369ddbb0e","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":51,"CreateTime":1637148417587608000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"48cf5aac-b3d1-4ead-ec9e-20b369ddbb0e","JobID":"gh11434","ModifyIndex":51,"ModifyTime":1637148417587608000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"AllocationUpdateDesiredStatus"}],"Index":51}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":52,"Key":"48cf5aac-b3d1-4ead-ec9e-20b369ddbb0e","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":51,"CreateTime":1637148417587608000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"48cf5aac-b3d1-4ead-ec9e-20b369ddbb0e","JobID":"gh11434","ModifyIndex":52,"ModifyTime":1637148417587608000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":52}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":53,"Key":"48cf5aac-b3d1-4ead-ec9e-20b369ddbb0e","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":51,"CreateTime":1637148417587608000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"48cf5aac-b3d1-4ead-ec9e-20b369ddbb0e","JobID":"gh11434","ModifyIndex":53,"ModifyTime":1637148417841991000,"Namespace":"default","Priority":90,"QueuedAllocations":{"cache":0},"SnapshotIndex":51,"Status":"complete","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":53}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":59,"Key":"4063f126-e2ab-dbe5-3322-745a5c57cdf8","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":59,"CreateTime":1637148429607760000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"4063f126-e2ab-dbe5-3322-745a5c57cdf8","JobID":"gh11434","ModifyIndex":59,"ModifyTime":1637148429607760000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"AllocationUpdateDesiredStatus"}],"Index":59}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":60,"Key":"4063f126-e2ab-dbe5-3322-745a5c57cdf8","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":59,"CreateTime":1637148429607760000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"4063f126-e2ab-dbe5-3322-745a5c57cdf8","JobID":"gh11434","ModifyIndex":60,"ModifyTime":1637148429607760000,"Namespace":"default","Priority":90,"Status":"pending","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":60}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":61,"Key":"4063f126-e2ab-dbe5-3322-745a5c57cdf8","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":59,"CreateTime":1637148429607760000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"4063f126-e2ab-dbe5-3322-745a5c57cdf8","JobID":"gh11434","ModifyIndex":61,"ModifyTime":1637148429860051000,"Namespace":"default","Priority":90,"QueuedAllocations":{"cache":0},"SnapshotIndex":59,"Status":"complete","TriggeredBy":"deployment-watcher","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":61}
```

4. Deregister the job using a custom eval priority.
```shell
$ nomad job stop -eval-priority=75 gh11434
```

As previously, the evaluations from the job deregistration will have the custom
eval priority.
```
{"Events":[{"FilterKeys":["gh11434",""],"Index":62,"Key":"73bd55ed-cd01-9bcd-6353-2f371b3067d2","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":62,"CreateTime":1637148475785925000,"ID":"73bd55ed-cd01-9bcd-6353-2f371b3067d2","JobID":"gh11434","JobModifyIndex":62,"ModifyIndex":62,"ModifyTime":1637148475785925000,"Namespace":"default","Priority":75,"Status":"pending","TriggeredBy":"job-deregister","Type":"service"}},"Topic":"Evaluation","Type":"JobDeregistered"}],"Index":62}
{"Events":[{"FilterKeys":["gh11434",""],"Index":63,"Key":"73bd55ed-cd01-9bcd-6353-2f371b3067d2","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":62,"CreateTime":1637148475785925000,"ID":"73bd55ed-cd01-9bcd-6353-2f371b3067d2","JobID":"gh11434","JobModifyIndex":62,"ModifyIndex":63,"ModifyTime":1637148475785925000,"Namespace":"default","Priority":75,"Status":"pending","TriggeredBy":"job-deregister","Type":"service"}},"Topic":"Evaluation","Type":"PlanResult"}],"Index":63}
{"Events":[{"FilterKeys":["gh11434","67ef1b7a-38f1-6885-f98d-4058ad7ec305"],"Index":64,"Key":"73bd55ed-cd01-9bcd-6353-2f371b3067d2","Namespace":"default","Payload":{"Evaluation":{"CreateIndex":62,"CreateTime":1637148475785925000,"DeploymentID":"67ef1b7a-38f1-6885-f98d-4058ad7ec305","ID":"73bd55ed-cd01-9bcd-6353-2f371b3067d2","JobID":"gh11434","JobModifyIndex":62,"ModifyIndex":64,"ModifyTime":1637148475787656000,"Namespace":"default","Priority":75,"QueuedAllocations":{"cache":0},"SnapshotIndex":62,"Status":"complete","TriggeredBy":"job-deregister","Type":"service"}},"Topic":"Evaluation","Type":"EvaluationUpdated"}],"Index":64}
```