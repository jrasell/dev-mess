- hosts: nomad_server
  roles:
    - role: common
      common_hostname: "{{ inventory_hostname }}"
      common_apt_packages: [
        "jq",
        "net-tools",
        "unzip",
      ]

    - role: hashicorp_release
      hashicorp_release_product_name: "nomad"
      hashicorp_release_product_version: "1.9.6"

    - role: gantsign.golang
      golang_gopath: "/home/{{ ansible_user_id }}/go"
      golang_version: "1.24.1"
      golang_redis_sha256sum: "8df5750ffc0281017fb6070fba450f5d22b600a02081dceef47966ffaf36a3af"

    - role: tls
      tls_self_signed_generate:
        - agent-name: "{{ inventory_hostname }}"
          ip: "{{ ansible_facts['default_ipv4']['address'] }}"
          dns: "server.lcy1.nomad"

    - role: helper
      helper_apt_packages:
        - "build-essential"
        - "git"
        - "make"
      helper_file_write_template:
        - src: "./templates/nomad_server.hcl.j2"
          dst: "/etc/nomad.d/server.hcl"
      helper_file_copy_local:
        - src: "./files/nomad.service"
          dst: "/etc/systemd/system/nomad.service"
        - src: "./.tls/ca-certificate.pem"
          dst: "/etc/nomad.d/.tls/ca.crt"
        - src: "./.tls/{{ inventory_hostname }}-certificate.pem"
          dst: "/etc/nomad.d/.tls/nomad.crt"
        - src: "./.tls/{{ inventory_hostname }}-certificate.key"
          dst: "/etc/nomad.d/.tls/nomad.key"
      helper_file_write_content_local:
        - content: "b6e63b6a-527c-14db-9474-063cb1dcc026\n"
          dst: "{{ playbook_dir }}/generated_nomad_root_bootstrap_token"
        - content: |
            NOMAD_TOKEN=b6e63b6a-527c-14db-9474-063cb1dcc026
            NOMAD_ADDR="https://{{ hostvars['nomad-server-0']['ansible_default_ipv4']['address'] }}:4646"
            NOMAD_CAPATH=./.tls/ca-certificate.pem
            NOMAD_CLIENT_CERT=./.tls/nomad-server-0-certificate.pem
            NOMAD_CLIENT_KEY=./.tls/nomad-server-0-certificate.key
          dst: "{{ playbook_dir }}/.envrc"
      helper_systemd_start_service_name: "nomad"
